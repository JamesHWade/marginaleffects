---
output: 
    - html_document
    - github_document
---

# The `marginaleffects` package for `R` <img src="https://user-images.githubusercontent.com/987057/134899484-e3392510-2e94-4c39-9830-53356fa5feed.png" align="right" alt="" width="120" />

<!--
[![Codecov test coverage](https://codecov.io/gh/vincentarelbundock/marginaleffects/branch/main/graph/badge.svg)](https://app.codecov.io/gh/vincentarelbundock/marginaleffects?branch=main)
[![R-CMD-check](https://github/To cl.com/vincentarelbundock/marginaleffects/workflows/R-CMD-check/badge.svg)](https://github.com/vincentarelbundock/marginaleffects/actions)
[![CRAN status](https://www.r-pkg.org/badges/version/marginaleffects)](https://CRAN.R-project.org/package=marginaleffects)
[![status](https://tinyverse.netlify.com/badge/marginaleffects)](https://CRAN.R-project.org/package=marginaleffects)
-->

```{r, include = FALSE}
options(width = 10000)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
#| echo = FALSE
url <- "https://raw.githubusercontent.com/vincentarelbundock/marginaleffects/main/data-raw/supported_models.csv"
dat <- read.csv(url)
n_support <- nrow(dat)
```

Compute and plot adjusted predictions, contrasts, marginal effects, and marginal means for `r n_support` classes of statistical models in `R`. Conduct linear and non-linear hypothesis tests using the delta method.

## Table of contents

Introduction:

* [Motivation](https://vincentarelbundock.github.io/marginaleffects/#motivation)
* [Installation](https://vincentarelbundock.github.io/marginaleffects/#installation)
* Interpreting model estimates
  1. [Estimands: Predictions, Comparisons, and Slopes](https://vincentarelbundock.github.io/marginaleffects/#estimands-predictions-comparisons-and-slopes)
  2. [Prediction Grid](https://vincentarelbundock.github.io/marginaleffects/#prediction-grid)
  3. [Averaging](https://vincentarelbundock.github.io/marginaleffects/#averaging)
  4. [Hypothesis Tests and Custom Contrasts](https://vincentarelbundock.github.io/marginaleffects/#hypothesis-tests)

```{r, child="vignettes/toc.Rmd"}
```

External links:

```{r, child="vignettes/toc_external.Rmd"}
```

## Motivation

Parameter estimates are often hard to interpret substantively, especially when they are generated by complex models with non-linear components or transformations. Many applied researchers would rather focus on simple quantities of interest, which have straightforward scientific interpretations. Unfortunately, these estimands (and their standard errors) are tedious to compute. Moreover, the different modeling packages in `R` often produce inconsistent objects that require special treatment.

`marginaleffects` offers a single point of entry to easily interpret the results of over `r n_support` classes of models, using a simple and consistent user interface.

Benefits of `marginaleffects` include:

* _Powerful:_ It can compute predictions, comparisons (contrasts, risk ratios, etc.), slopes, and conduct hypothesis tests for `r n_support` different classes of models in `R`.
* _Simple:_ All functions share a simple, unified, and well-documented interface.
* _Efficient:_ [Some operations](https://vincentarelbundock.github.io/marginaleffects/articles/performance.html) are orders of magnitude faster than with the `margins` package, and the memory footprint is much smaller.
* _Valid:_  When possible, [numerical results are checked](https://vincentarelbundock.github.io/marginaleffects/articles/supported_models.html) against alternative software like `Stata` or other `R` packages.
* _Thin:_ Few dependencies.
* _Standards-compliant:_ `marginaleffects` follows "tidy" principles and returns objects that work with standard functions like `plot`, `summary()`, `tidy()`, and `glance()`. These objects are easy to program with and feed to [other packages like `modelsummary`.](https://vincentarelbundock.github.io/marginaleffects/) 
* _Extensible:_ Adding support for new models is very easy, often requiring less than 10 lines of new code. Please submit [feature requests on Github.](https://github.com/vincentarelbundock/marginaleffects/issues)
* _Active development_: Bugs are fixed promptly.

Downsides of `marginaleffects` include:

* No multiplicity adjustments. (Use `p.adjust()` instead.)
* Marginal means are often slower to compute than with `emmeans`.
* No omnibus test

If `marginaleffects` does not meet your needs, I recommend you try [`emmeans`](https://github.com/rvlenth/emmeans) or one of the other [alternative `R` packages.](https://vincentarelbundock.github.io/marginaleffects/articles/alternative_software.html)

## Installation

You can install the released version of `marginaleffects` from CRAN:

```{r, eval=FALSE}
install.packages("marginaleffects")
```

You can install the development version of `marginaleffects` (and its dependency `insight`) from R-Universe:

```{r, eval=FALSE}
install.packages(
    c("marginaleffects", "insight"),
    repos = c(
        "https://vincentarelbundock.r-universe.dev",
        "https://easystats.r-universe.dev"))
```

**Restart `R` completely before moving on.** 

## Estimands: Predictions, Comparisons, and Slopes

The `marginaleffects` package allows `R` users to compute and plot three principal quantities of interest: (1) predictions, (2) comparisons, and (3) slopes. In addition, the package includes a convenience function to compute a fourth estimand, "marginal means", which is a special case of averaged predictions.

[_Predictions_:](https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html)

> The outcome predicted by a fitted model on a specified scale for a given combination of values of the predictor variables, such as their observed values, their means, or factor levels. a.k.a. Fitted values, adjusted predictions.

[_Comparisons_:](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html)

> The difference between two predictions, calculated for meaningfully different predictor values (e.g., College graduates vs.Â Others). Instead of a difference, comparisons can be constructed using other functions of two adjusted predictions, such as a ratio.  Ex: Contrasts, risk ratios, log odds, etc.

[_Slopes_:](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html) 

> Partial derivatives of the regression equation with respect to a regressor of interest. a.k.a. Marginal effects, trends.

[_Marginal Means_:](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html) 

> Predictions of a model, averaged across a "reference grid" of categorical predictors.

#### Unit-level quantities

Predictions, comparisons, and slopes are fundamentally unit-level (or "conditional") quantities. Except in the simplest linear case, estimates will typically vary based on the values of all the regressors in a model. Each of the observations in a dataset is thus associated with its own prediction, comparison, or slope estimate. Below, we will see that it can be useful to marginalize (or "average over") unit-level estimates to report an "average prediction", "average comparison", or "average slope".

#### What does "marginal" mean?

One ambiguous aspect of the definitions above is that the word "marginal" comes up in two different and *opposite* ways: 

1. In "marginal effects," we refer to the effect of a tiny (marginal) change in the regressor on the outcome. This is a slope, or derivative. 
2. In "marginal means," we refer to the process of marginalizing across rows of a prediction grid. This is an average, or integral. 

On this website and in this package, we reserve the expression "marginal effect" to mean a "slope" or "derivative".

#### Functions for each estimand

The `marginaleffects` package includes functions to estimate, average, plot, and summarize all of the estimands described above. The objects produced by `marginaleffects` are "tidy": they produce simple data frames in "long" format. They are also "standards-compliant" and work seamlessly with standard functions like `summary()`, `plot()`, `tidy()`, and `glance()`, as well with [external packages like `modelsummary`.](https://vincentarelbundock.github.io/marginaleffects/)

| Estimand | Functions |
| ----------- | -------- |
| [Predictions](https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html) | [`predictions()`](https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html) |
| | [`plot_cap()`](https://vincentarelbundock.github.io/marginaleffects/reference/plot_cap.html) |
| [Comparisons](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html) | [`comparisons()`](https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html) |
| | [`plot_cco()`](https://vincentarelbundock.github.io/marginaleffects/reference/plot_cap.html) |
| | [`plot_avg()`](https://vincentarelbundock.github.io/marginaleffects/reference/plot_avg.html) |
| [Slopes](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html) | [`comparisons()`](https://vincentarelbundock.github.io/marginaleffects/reference/slopes.html) |
| | [`plot_cme()`](https://vincentarelbundock.github.io/marginaleffects/reference/plot_cme.html) |
| | [`plot_avg()`](https://vincentarelbundock.github.io/marginaleffects/reference/plot_avg.html) |
| [Marginal means](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html) | [`marginalmeans()`](https://vincentarelbundock.github.io/marginaleffects/reference/marginalmeans.html) |

#### Examples
 
```{r}
library(marginaleffects)

mod <- lm(mpg ~ hp * wt * am, data = mtcars)

pre <- predictions(mod)
dim(pre)
head(pre)
```

```{r}
cmp <- comparisons(mod)
dim(cmp)
head(cmp)

cmp <- comparisons(mod, variables = list(hp = c(120, 100)))
head(cmp)

cmp <- comparisons(mod, variables = list(hp = "sd"))
head(cmp)
```

```{r}
mfx <- slopes(mod)
dim(mfx)
head(mfx)
```

## Prediction grid

## Averaging

Another potential confusion arises when some analysts use "marginal" to distinguish some estimates from "conditional" ones. As noted in [the marginal effects](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html) and [the contrasts](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html) vignettes, slopes and contrasts often vary from individual to individual, based on the values of all the regressors in the model. When we estimate a slope or a contrast for a specific combination of predictors -- for one (possibly representative) individual -- some people will call this a "conditional" estimate. When we compute the average of several individual-level estimates, some people will call this a "marginal" estimate. 

This is all very confusing, but the terminology is so widespread and inconsistent that we must press on...

## Hypothesis tests


## Getting started

#### Adjusted predictions

To begin, we estimate a linear regression model with multiplicative interactions:

```{r}
library(marginaleffects)

mod <- lm(mpg ~ hp * wt * am, data = mtcars)
```

An "adjusted prediction" is the outcome predicted by a model for some combination of the regressors' values, such as their observed values, their means, or factor levels (a.k.a. âreference gridâ).

By default, the `predictions()` function returns adjusted predictions for every value in original dataset:

```{r}
predictions(mod) |> head()
```

The [`datagrid` function gives us a powerful way to define a grid of predictors.](https://vincentarelbundock.github.io/marginaleffects/reference/datagrid.html) All the variables not mentioned explicitly in `datagrid()` are fixed to their mean or mode:

```{r}
predictions(mod, newdata = datagrid(am = 0, wt = seq(2, 3, .2)))
```

We can plot how predictions change for different values of one or more variables -- Conditional Adjusted Predictions -- using the `plot_cap` function:

```{r}
plot_cap(mod, condition = c("hp", "wt"))
```

```{r}
mod2 <- lm(mpg ~ factor(cyl), data = mtcars)
plot_cap(mod2, condition = "cyl")
```

[The Adjusted Predictions vignette](https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html) shows how to use the `predictions()` and `plot_cap()` functions to compute a wide variety of quantities of interest:

* Adjusted Predictions at User-Specified Values (aka Predictions at Representative Values)
* Adjusted Predictions at the Mean
* Average Predictions at the Mean
* Conditional Predictions
* Adjusted Predictions on different scales (e.g., link or response)

#### Contrasts

A contrast is the difference between two adjusted predictions, calculated for meaningfully different predictor values (e.g., College graduates vs. Others).

What happens to the predicted outcome when a numeric predictor increases by one unit, and logical variable flips from FALSE to TRUE, and a factor variable shifts from baseline?

```{r}
titanic <- read.csv("https://vincentarelbundock.github.io/Rdatasets/csv/Stat2Data/Titanic.csv")
titanic$Woman <- titanic$Sex == "female"
mod3 <- glm(Survived ~ Woman + Age * PClass, data = titanic, family = binomial)

cmp <- comparisons(mod3)
summary(cmp)
```

The contrast above used a simple difference between adjusted predictions. We can also used different functions to combine and contrast predictions in different ways. For instance, researchers often compute Adjusted Risk Ratios, which are ratios of predicted probabilities. We can compute such ratios by applying a transformation using the `transform_pre` argument. We can also present the results of "interactions" between contrasts. 
What happens to the ratio of predicted probabilities for survival when `PClass` changes between each pair of factor levels ("pairwise") and `Age` changes by 2 standard deviations simultaneously:

```{r}
cmp <- comparisons(
    mod3,
    transform_pre = "ratio",
    variables = list(Age = "2sd", PClass = "pairwise"))
summary(cmp)
```

The code above is explained in detail in the [vignette on Transformations and Custom Contrasts.](https://vincentarelbundock.github.io/marginaleffects/articles/transformation.html)

[The Contrasts vignette](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html) shows how to use the `comparisons()` function to compute a wide variety of quantities of interest:

* Custom comparisons for:
  - Numeric variables (e.g., 1 standard deviation, interquartile range, custom values)
  - Factor or character
  - Logical
* Contrast interactions
* Unit-level Contrasts
* Average Contrasts
* Group-Average Contrasts
* Contrasts at the Mean
* Contrasts Between Marginal Means
* Adjusted Risk Ratios

#### Marginal effects

A "marginal effect" is a partial derivative (slope) of the regression equation with respect to a regressor of interest. It is unit-specific measure of association between a change in a regressor and a change in the regressand. The `slopes()` function uses numerical derivatives to estimate the slope of the regression equation with respect to each of the variables in the model (or contrasts for categorical variables). 

By default, `slopes()` estimates the slope for each row of the original dataset that was used to fit the model:

```{r}
mfx <- slopes(mod)

head(mfx, 4)
```

The function `summary` calculates the "Average Marginal Effect," that is, the average of all unit-specific marginal effects:

```{r}
summary(mfx)
```

The `plot_cme` plots "Conditional Marginal Effects," that is, the marginal effects estimated at different values of a regressor (often an interaction):

```{r}
plot_cme(mod, effect = "hp", condition = c("wt", "am"))
```

[The Marginal Effects vignette](https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html) shows how to use the `slopes()` function to compute a wide variety of quantities of interest:

* Unit-level Marginal Effects
* Average Marginal Effects
* Group-Average Marginal Effects
* Marginal Effects at the Mean
* Marginal Effects Between Marginal Means
* Conditional Marginal Effects
* Tables and Plots

#### Marginal means

Marginal Means are the adjusted predictions of a model, averaged across a âreference gridâ of categorical predictors. To compute marginal means, we first need to make sure that the categorical variables of our model are coded as such in the dataset:

```{r}
dat <- mtcars
dat$am <- as.logical(dat$am)
dat$cyl <- as.factor(dat$cyl)
```

Then, we estimate the model and call the `marginalmeans` function:

```{r}
mod <- lm(mpg ~ am + cyl + hp, data = dat)
mm <- marginalmeans(mod)
summary(mm)
```

[The Marginal Means vignette](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html) offers more detail.

#### More

There is *much* more you can do with `marginaleffects`. Return to the [Table of Contents](https://vincentarelbundock.github.io/marginaleffects/#table-of-contents) to read the vignettes, learn how to report marginal effects and means in [nice tables with the `modelsummary` package](https://vincentarelbundock.github.io/modelsummary/), how to define your own prediction "grid", and much more.
