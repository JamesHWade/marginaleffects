---
output: github_document
---

# The `marginaleffects` package for `R`

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Codecov test coverage](https://codecov.io/gh/vincentarelbundock/marginaleffects/branch/main/graph/badge.svg)](https://codecov.io/gh/vincentarelbundock/marginaleffects?branch=main)
[![R-CMD-check](https://github.com/vincentarelbundock/marginaleffects/workflows/R-CMD-check/badge.svg)](https://github.com/vincentarelbundock/marginaleffects/actions)
<!-- badges: end -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

This package is still experimental. *Use with caution!*

## What?

The `marginaleffects` package allows `R` users to compute and plot three principal quantities of interest for a *wide* variety of models:

* [_Marginal Effect_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/mfx.html) 
    - A partial derivative (slope) of the regression equation with respect to a regressor of interest.
* [_Marginal Mean_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html) 
    - Response predicted by a model for some combination of the regressors' values (a.k.a. "reference grid"), typically their means or factor levels. 
* [_Contrast_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html) 
    - The difference between two Marginal Means, calculated for meaningfully different regressor values (e.g., College graduates vs. Others).

## Why?

To calculate marginal effects we need to take derivatives of the regression equation. This can be challenging to do manually, especially when our models are non-linear, or when regressors are transformed or interacted. Computing the variance of a marginal effect is even more difficult. 

The `marginaleffects` package hopes to do most of this hard work for you.

Many `R` packages advertise their ability to compute "marginal effects." However, most of them do *not* actually compute marginal effects *as defined above*. Instead, they compute fitted values for different predictor values (i.e., "Marginal Means"), or differences in fitted values (i.e., "contrasts"). The rare packages that actually compute marginal effects are typically limited in the model types they support, and in the range of transformations they allow (interactions, polynomials, etc.).

The main package in the `R` ecosystem to compute marginal effects is [the fantastic, trailblazing, and powerful `margins`](https://cran.r-project.org/web/packages/margins/index.html) by [Thomas J. Leeper.](https://thomasleeper.com/) The `marginaleffects` package is (essentially) a clone of Leeper's `margins` and `prediction` packages. 

So why did I write a clone?

* _Speed:_ [In one benchmark,](https://vincentarelbundock.github.io/marginaleffects/articles/benchmark.html) computing unit-level standard errors is over 400x faster with `marginaleffects` (minutes vs. milliseconds).
* _Efficiency:_ Smaller memory footprint (1.8GB vs 52MB in the same example).
* _Extensibility:_ Adding support for new models is very easy, often requiring less than 10 lines of new code. In the medium run, the goal is to add support for *several* more model types.
* `ggplot2` support for plotting (conditional) marginal effects.
* _Tidy:_ The results produced by `marginaleffects` follow "tidy" principles. They are easy to process and program with. 
* _User interface:_ All functions share an extremely simple, unified, and well-documented interface.
* _Dependencies_: The package is built on very few dependencies. The only "true" dependencies are `numDeriv` which has been on the CRAN archive since 2006, and `insight` which is itself dependency-free.
* _Safe:_  User input is checked extensively before computation. When needed, functions fail gracefully with informative error messages.
* _Active development_

Downsides of `marginaleffects` include:

* Weights and simultation-based inference are not (yet) supported.
* Newer package with a smaller (read: nonexistent) user base.

## How?

By using [the `numDeriv` package](https://cran.r-project.org/web/packages/numDeriv/index.html) to compute gradients and jacobians, and [the `insight` package](https://easystats.github.io/insight/) to extract information from model objects. That's it. That's the secret sauce.

## Supported models

This table shows the list of models supported by `marginaleffect`, and shows which numerical results have been checked against alternative software packages: Stata's `margins` command and R's `margins` package. 

I am *very* eager to add support for new models. Feel free to file a request on Github or -- even better -- submit some code.

Warning: When using `marginaleffects` with different models, you will probably have to adjust the `type` argument. Refer to the documentation of your modeling package to see what `type` argument is allowed in the `predict` function. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(marginaleffects)
library(kableExtra)
kbl(supported_models, format = "pipe") %>% 
    kable_styling() 
```

## Installation

You can install the latest version of `marginaleffects` from Github:

```{r, eval=FALSE}
remotes::install_github("vincentarelbundock/marginaleffects")
```

## Getting started

First, we estimate a linear regression model with multiplicative interactions:

```{r}
library(marginaleffects)

mod <- lm(mpg ~ hp * wt * am, data = mtcars)
```

A "marginal effect" is a unit-specific measure of association between a change in a regressor and a change in the regressand. The `marginaleffects` function thus computes a distinct estimate of the marginal effect and of the standard error for each regressor ("term"), for each unit of observation ("rowid"). You can view and manipulate the full results with functions like `head`, as you would with any other `data.frame`:

```{r}
mfx <- marginaleffects(mod)

head(mfx, 4)
```

The function `summary` calculates the "Average Marginal Effect," that is, the average of all unit-specific marginal effects:

```{r}
summary(mfx)
```

The `plot_cme` plots "Conditional Marginal Effects," that is, it plots the value of a marginal effect for different values of a regressor (often an interaction):

```{r}
plot_cme(mod, effect = "hp", condition = c("wt", "am"))
```

Beyond marginal effects, we can also use the `marginalmeans` function to estimate -- you guessed it -- marginal means. We use the `variables` argument to select the categorical variables that will form the "grid":

```{r, message=FALSE}
marginalmeans(mod, variables = c("am", "wt"))
```

The [`typical` function gives us an even more powerful way](https://vincentarelbundock.github.io/marginaleffects/reference/typical.html) to customize the grid:


```{r}
marginalmeans(mod, newdata = typical(am = 0, wt = c(2, 4)))
```

We can plot the estimated means (a.k.a. regression-adjusted predictions) with the `plot_cmm` function:

```{r}
plot_cmm(mod, condition = c("hp", "wt"))
```

Or you can work with the output of the `marginalmeans` or `marginaleffects` directly to create your own plots. For example:

```{r}
library(ggplot2)

marginalmeans(mod, 
              newdata = typical(am = 0:1, 
                                wt = fivenum(mtcars$wt), 
                                hp = seq(100, 300, 10))) %>%
    ggplot(aes(x = hp, y = predicted, ymin = conf.low, ymax = conf.high)) +
    geom_ribbon(aes(fill = factor(wt)), alpha = .2) +
    geom_line(aes(color = factor(wt))) +
    facet_wrap(~am)
```

There is *much* more you can do with `marginaleffects`. Please read the other articles on this website to learn more:

* [_Marginal Effect_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/mfx.html) 
* [_Marginal Mean_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/marginalmeans.html) 
* [_Contrast_ (Vignette)](https://vincentarelbundock.github.io/marginaleffects/articles/contrasts.html) 
