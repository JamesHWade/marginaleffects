---
title: "Unit-level contrasts in logistic regressions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Unit-level contrasts in logistic regression}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# this vignette is in .Rbuildignore

knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 9,
  fig.asp = .4,
  out.width = "100%",
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)
```

Note: This vignette requires version 0.8.0 of `marginaleffects`, or [the development version from Github.](https://vincentarelbundock.github.io/marginaleffects/#installation)

This vignette replicates some of the analyses in this excellent blog post by Frank Harrell: [Avoiding One-Number Summaries of Treatment Effects for RCTs with Binary Outcomes](https://www.fharrell.com/post/rdist/). Here, we show how one-number summaries and the entire distribution unit-level contrasts can be easily computed with `comparisons()`.

Dr. Harrell discusses summaries from logistic regression models in the blog post above. He focuses on a context in which one is interested in comparing two groups, such as in randomized controlled trials. He highlights potential pitfalls of presenting "one-number summmaries", e.g., odds ratio and mean proportion difference. Finally, he recommends focusing on the entire distribution of proportion difference between groups.

For clarification, we use the following terms interchangeably in the context of logistic regression where the covariate of interest is categorical:

- Contrast
- Proportion difference
- Risk difference
- Absolute risk reduction

# Data

We focus on subset data from the [GUSTO-I study](https://www.nejm.org/doi/full/10.1056/NEJM199309023291001), where patients were randomly assigned to accelerated tissue plasminogen activator (tPA) or streptokinase (SK).

Load libraries, data and fit a covariate-adjusted logistic regression model. 

```{r, message = FALSE, warning = FALSE}
library(marginaleffects)
library(rms)

load(url(
"https://github.com/vincentarelbundock/modelarchive/raw/main/data-raw/gusto.rda"
))

gusto <- subset(gusto, tx %in% c("tPA", "SK"))
gusto$tx <- factor(gusto$tx, levels = c("tPA", "SK"))

mod <- glm(
    day30 ~ tx + rcs(age, 4) + Killip + pmin(sysbp, 120) + lsp(pulse, 50) +
    pmi + miloc + sex, family = "binomial",
    data = gusto)
```

## One-Number Summaries

Population-averaged (aka "marginal") proportion difference ([see this vignette](https://vincentarelbundock.github.io/marginaleffects/articles/gformula.html)):

```{r}
comparisons(
    mod,
    variables = "tx") |> 
    summary()
```

The `comparisons()` function above computed the predicted probability of `day30==1` for each observed row of the data in two couterfactual cases: when `tx` is "SK", and when `tx` is "tPA". Then, it computed the differences between these two sets of predictions. Finally, it computed the population-average of risk differences.

Now we want to obtain population-averaged adjusted odds ratio. Since odds ratios are non-collapsible, we cannot use the same strategy with them. Instead, we call `transform_pre="lnoravg`. Let `hi` be the vector of predicted probabilities when `tx` is "SK", and let `lo` be the vector of predicted probabilities when `tx` is "tPA". Then, the `transform_pre="lnoravg"` applies this function:

```r
log((mean(hi)/(1 - mean(hi)))/(mean(lo)/(1 - mean(lo))))
```

Finally, we use `transform_post=exp` to exponentiate the results.

```{r}
comparisons(
    mod,
    variables = "tx",
    transform_pre = "lnoravg",
    transform_post = exp) |>
    summary()
```

Population-averaged (marginal) adjusted risk ratio (proportion):

```{r}
comparisons(
    mod,
    variables = "tx",
    transform_pre = "lnratioavg",
    transform_post = exp) |>
    summary()
```

## Unit-level Summaries

Instead of estimating one-number summaries, we can focus on unit-level proportion differences using `comparisons()`. This function applies the fitted logistic regression model to predict outcome probabilities for each patient, i.e., unit-level. 

```{r}
cmp <- comparisons(mod, variables = "tx")

head(cmp)
```

Show the predicted probability for individual patients under both treatment alternatives.

```{r, fig.asp = 1}
plot(x = cmp$predicted_hi,
     y = cmp$predicted_lo,
     main = "Risk of Mortality",
     xlab = "SK",
     ylab = "tPA")

abline(0, 1)
```

Lastly, present the entire distribution of unit-level proportion differences and its mean and median.

```{r}
hist(cmp$comparison,
     breaks = 100,
     main = "Distribution of unit-level contrasts",
     xlab = "SK - tPA")
abline(v = mean(cmp$comparison), col = "red")
abline(v = median(cmp$comparison), col = "blue")
```


## Appendix

`comparisons()` performed the following calculations under the hood:

```{r}
d  <- gusto

d$tx = "SK"
predicted_hi <- predict(mod, newdata = d, type = "response")

d$tx = "tPA"
predicted_lo <- predict(mod, newdata = d, type = "response")

comparison <- predicted_hi - predicted_lo
```

The original dataset contains 30510 patients, thus `comparisons()` generates an output with same amount of rows.

```{r}
nrow(gusto)
```

```{r}
nrow(cmp)
```



