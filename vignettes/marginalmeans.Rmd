---
title: "Marginal Means" 
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Definitions: Marginal Effects, Estimated Marginal Means, Conditional Probabilities, and Contrasts}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  fig.width = 6,
  fig.asp = .4,
  warning = FALSE,
  message = FALSE,
  comment = "#>"
)

library(marginaleffects)
library(patchwork)
library(ggplot2)

theme_set(theme_minimal())
```

In the context of this package, a "Marginal Mean" is defined as:

> The reponse predicted by a model for some combination of the regressors' values, typically their means or factor levels. 

This differs from "Fitted Values" (a.k.a. "Predictions") because the combination of regressor values being consider do not 

By default, the `marginaleffects` function returns predicted/estimated responses for each of the observations in the dataset:

```{r}
mod <- lm(mpg ~ hp + factor(cyl), data = mtcars)
mfx <- marginaleffects(mod)
head(mfx)
```

We can also request these responses for specific values of the regressors, using the `typical` function, in the `newdata` argument. By default, `typical` will set any variable which is not explicitly specify to its mean value. For example, 

```{r}
typical(cyl = c(4, 6, 8), model = mod)
```

This gives us 3 "typical observations" -- or "margins" -- at which we can do prediction. Using the `marginaleffects` function to extract those predictions gives us:

```{r, echo = FALSE}
emm <- marginaleffects(mod, newdata = typical(cyl = c(4, 6, 8)))$predicted_response
emm <- paste(sprintf("%.1f", emm), collapse = ", ")
```

```{r}
marginaleffects(mod, newdata = typical(cyl = c(4, 6, 8)))
```

The `emmeans` package refers to the set of observations that we just used to compute predicted values as a "reference grid," but the idea is the same. Indeed, our `predicted_response` values (`r emm`) are exactly identical to the EMMs computed by the `emmeans` package:

```{r}
library(emmeans)
emmeans(mod, specs = "cyl")
```
